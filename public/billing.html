<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HJS · Usage & Billing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=JetBrains+Mono:wght@400;500;600&display=swap');
        * { font-family: 'Inter', system-ui, sans-serif; }
        .font-mono, code, pre { font-family: 'JetBrains Mono', monospace !important; }
        body { background: #0a0a0a; color: #e5e5e5; min-height: 100vh; }
        html { scroll-behavior: smooth; overflow-y: scroll; }
        .text-steel { color: #3B4B5C; }
        .border-steel { border-color: #3B4B5C; }
        .bg-steel\/10 { background-color: rgba(59, 75, 92, 0.1); }
        .bg-steel\/20 { background-color: rgba(59, 75, 92, 0.2); }
        .hover\:bg-steel\/20:hover { background-color: rgba(59, 75, 92, 0.2); }
        .bg-card { background: rgba(26, 26, 26, 0.5); }
        .border-border { border-color: #1f1f1f; }
        .text-muted-foreground { color: #9ca3af; }
        .text-foreground { color: #e5e5e5; }
        .bg-background { background: #0a0a0a; }
        .hover\:border-steel:hover { border-color: #3B4B5C; }
        .hover\:text-foreground:hover { color: #e5e5e5; }
        .disabled\:opacity-60:disabled { opacity: 0.6; }
        .disabled\:cursor-not-allowed:disabled { cursor: not-allowed; }
        .focus\:border-steel:focus { border-color: #3B4B5C; }
        .focus\:ring-steel:focus { ring-color: #3B4B5C; }
        
        /* 动画 */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-in {
            animation: fade-in 0.3s ease-out;
        }
        
        /* 圆角 */
        .rounded { border-radius: 0.25rem; }
        /* 防止页面跳动 */n        html { overflow-y: scroll; }n        body { min-height: 100vh; display: flex; flex-direction: column; }
    
        /* 统一导航栏样式 */
        nav {
            display: flex;
            justify-content: flex-start; gap: 3rem;
            align-items: center;
            padding-top: 1.5rem;
            padding-bottom: 1.5rem;
        }
        nav a:first-child {
            font-size: 1.125rem;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
            text-decoration: none;
        }
        nav .nav-links {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        @media (min-width: 768px) {
            nav .nav-links {
                gap: 2rem;
            }
        }
        nav .nav-link {
            color: #9ca3af;
            font-size: 1rem;
            text-decoration: none;
            transition: color 0.2s;
            white-space: nowrap;
        }
        nav .nav-link:hover {
            color: #5ee0c0;
        }
        nav .nav-link.active {
            color: white;
        }
        nav select {
            background: transparent;
            color: #9ca3af;
            font-size: 0.75rem;
            border: none;
            cursor: pointer;
            flex-shrink: 0;
            margin-left: 1rem;
        }
</style>
<script>
        // 预翻译关键内容，在页面渲染前执行
        (function() {
            const savedLang = localStorage.getItem('hjs_lang');
            const urlParams = new URLSearchParams(window.location.search);
            const urlLang = urlParams.get('lang');
            const browserLang = navigator.language || navigator.userLanguage;
            const lang = urlLang || savedLang || (browserLang.toLowerCase().startsWith('zh') ? 'zh' : 'en');
            
            if (!savedLang || urlLang) {
                localStorage.setItem('hjs_lang', lang);
            }
            if (urlLang) {
                const url = new URL(window.location);
                url.searchParams.delete('lang');
                window.history.replaceState({}, '', url);
            }
            document.documentElement.lang = lang;
            
            // 关键翻译映射（导航栏）
            const navTranslations = {
                zh: {
                    'nav_home': '首页', 'nav_product': '产品', 'nav_developers': '开发者',
                    'nav_console': '控制台', 'nav_lookup': '查询', 'nav_billing': '计费',
                    'nav_roi': 'ROI', 'nav_governance': '治理'
                },
                en: {
                    'nav_home': 'Home', 'nav_product': 'Product', 'nav_developers': 'Developers',
                    'nav_console': 'Console', 'nav_lookup': 'Lookup', 'nav_billing': 'Billing',
                    'nav_roi': 'ROI', 'nav_governance': 'Governance'
                }
            };
            
            // 立即翻译（在DOM加载前）
            if (lang !== 'en' && navTranslations[lang]) {
                const originalContent = document.documentElement.innerHTML;
                let newContent = originalContent;
                
                // 替换关键文本
                Object.keys(navTranslations[lang]).forEach(key => {
                    const regex = new RegExp('data-i18n="' + key + '">([^<]+)', 'g');
                    newContent = newContent.replace(regex, 'data-i18n="' + key + '">' + navTranslations[lang][key]);
                });
                
                if (newContent !== originalContent) {
                    document.documentElement.innerHTML = newContent;
                }
            }
        })();
    </script>
</head>
<body>
    <div class="mx-auto max-w-4xl px-6 pt-12 pb-12">
        <!-- ===== 导航栏 ===== -->
        <!-- 导航栏 -->
        <!-- 导航栏 -->
        <div class="flex items-center py-6 text-base gap-8">
            <a href="/" class="text-white font-semibold text-lg flex-shrink-0">HJS</a>
            <div class="flex gap-6 md:gap-8 text-gray-400">
                <a href="/" class="hover:text-teal-400 transition" data-i18n="nav_home">Home</a>
                <a href="/product.html" class="hover:text-teal-400 transition" data-i18n="nav_product">Product</a>
                <a href="/developers.html" class="hover:text-teal-400 transition" data-i18n="nav_developers">Developers</a>
                <a href="/console.html" class="hover:text-teal-400 transition" data-i18n="nav_console">Console</a>
                <a href="/lookup.html" class="hover:text-teal-400 transition" data-i18n="nav_lookup">Lookup</a>
                <a href="/billing.html" class="text-white" data-i18n="nav_billing">Billing</a>
                <a href="/roi-calculator.html" class="hover:text-teal-400 transition" data-i18n="nav_roi">ROI</a>
                <a href="/governance.html" class="hover:text-teal-400 transition" data-i18n="nav_governance">Governance</a>
            </div>
            <select onchange="switchLang(this.value)" class="bg-transparent text-gray-400 text-xs ml-auto">
                <option value="en">EN</option>
                <option value="zh">中文</option>
            </select>
        </div>

        <!-- Header -->
        <section class="py-24">
            <p class="mb-4 font-mono text-xs text-gray-500" data-i18n="bill_version_tag">
                HJS Responsibility Protocol · v1.0 Beta
            </p>
            <h1 class="mt-6 text-3xl font-light leading-tight tracking-tight text-white md:text-4xl" data-i18n="bill_title">
                Usage & Billing
            </h1>
            <p class="mt-4 max-w-xl text-sm leading-relaxed text-gray-400" data-i18n="bill_subtitle">
                Free storage · Pay only for anchoring
            </p>
        </section>

        <!-- Auth -->
        <div id="auth-section" class="mb-12">
            <!-- 未认证状态 -->
            <div id="unauth-state" class="border border-gray-800 bg-card p-6">
                <h2 class="font-mono text-xs uppercase tracking-widest text-gray-400" data-i18n="bill_auth_heading">
                    EMAIL AUTHENTICATION
                </h2>
                <div class="mt-4 flex gap-2">
                    <input
                        type="email"
                        id="email-input"
                        placeholder="your@email.com"
                        class="flex-1 border border-gray-800 bg-background px-3 py-2 font-mono text-sm text-white placeholder:text-gray-500 outline-none transition-colors focus:border-steel"
                    />
                    <button
                        id="verify-btn"
                        class="shrink-0 border border-steel bg-steel/10 px-5 py-2 text-xs font-medium text-white transition-colors hover:bg-steel/20 disabled:opacity-40 disabled:cursor-not-allowed"
                    >
                        Verify
                    </button>
                </div>
            </div>

            <!-- 已认证状态 -->
            <div id="auth-state" class="hidden border-b border-gray-800 pb-4">
                <div class="flex justify-between items-center">
                    <p class="font-mono text-xs text-gray-400">
                        <span data-i18n="con_auth_current">Current</span>: <span id="current-email" class="text-white"></span>
                    </p>
                    <button
                        id="logout-btn"
                        class="border border-gray-700 px-4 py-1.5 text-xs text-gray-400 transition-colors hover:text-white"
                    >
                        Logout
                    </button>
                </div>
            </div>
        </div>

        <!-- Main content -->
        <section id="billing-content" class="grid gap-6 pb-12 md:grid-cols-2 opacity-40 pointer-events-none">
            <!-- Left column: Balance + Rates + Monthly usage -->
            <div class="flex flex-col gap-6">
                <!-- Balance -->
                <div class="border border-gray-800 bg-card p-6">
                    <span class="text-[10px] uppercase tracking-wider text-gray-400" data-i18n="bill_balance">
                        CURRENT BALANCE
                    </span>
                    <div class="mt-2 flex items-baseline gap-3">
                        <span class="font-mono text-4xl font-light text-white" id="balance-amount">$0.00</span>
                        <span id="topup-success" class="hidden font-mono text-sm text-steel animate-in"></span>
                    </div>
                </div>

                <!-- Tiered Pricing Table -->
                <div class="border border-gray-800 bg-card p-6">
                    <span class="mb-4 block text-[10px] uppercase tracking-wider text-gray-400" data-i18n="bill_rates">
                        TIERED RATES
                    </span>
                    
                    <!-- Current Tier Badge -->
                    <div id="current-tier-badge" class="mb-4 p-3 border border-steel bg-steel/10 rounded">
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-400" data-i18n="bill_current_tier">Current Tier</span>
                            <span id="current-tier-name" class="font-mono text-sm text-white font-medium">Experience</span>
                        </div>
                        <div class="mt-2 flex items-baseline gap-2">
                            <span id="current-tier-price" class="font-mono text-2xl text-white">$0.03</span>
                            <span class="text-xs text-gray-500" data-i18n="bill_per_anchor">/anchor</span>
                        </div>
                        <div id="next-tier-progress" class="mt-2">
                            <div class="flex justify-between text-xs text-gray-500 mb-1">
                                <span id="anchors-this-month">0 anchors</span>
                                <span id="next-tier-threshold">100 to Standard</span>
                            </div>
                            <div class="h-1 bg-gray-800 rounded-full overflow-hidden">
                                <div id="tier-progress-bar" class="h-full bg-steel transition-all" style="width: 0%"></div>
                            </div>
                            <p id="next-tier-savings" class="text-xs text-green-400 mt-1">Save 33% at next tier</p>
                        </div>
                    </div>
                    
                    <!-- Pricing Tiers Table -->
                    <div class="space-y-2">
                        <div class="tier-row flex items-center justify-between p-2 rounded text-sm" data-tier="experience">
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-gray-600"></span>
                                <span class="text-gray-400" data-i18n="bill_tier_experience">Experience</span>
                                <span class="text-xs text-gray-600">0-100</span>
                            </div>
                            <span class="font-mono text-white">$0.03</span>
                        </div>
                        <div class="tier-row flex items-center justify-between p-2 rounded text-sm" data-tier="standard">
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-gray-600"></span>
                                <span class="text-gray-400" data-i18n="bill_tier_standard">Standard</span>
                                <span class="text-xs text-gray-600">101-1K</span>
                            </div>
                            <span class="font-mono text-white">$0.02</span>
                        </div>
                        <div class="tier-row flex items-center justify-between p-2 rounded text-sm" data-tier="bulk">
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-gray-600"></span>
                                <span class="text-gray-400" data-i18n="bill_tier_bulk">Bulk</span>
                                <span class="text-xs text-gray-600">1K-10K</span>
                            </div>
                            <span class="font-mono text-white">$0.01</span>
                        </div>
                        <div class="tier-row flex items-center justify-between p-2 rounded text-sm" data-tier="enterprise">
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-gray-600"></span>
                                <span class="text-gray-400" data-i18n="bill_tier_enterprise">Enterprise</span>
                                <span class="text-xs text-gray-600">10K+</span>
                            </div>
                            <span class="font-mono text-white">$0.005</span>
                        </div>
                    </div>
                    
                    <!-- Storage Note -->
                    <div class="mt-4 pt-3 border-t border-gray-800">
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-400">Record Storage</span>
                            <span class="text-green-400 font-medium">FREE</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            Bitcoin network fee: ~$0.32 per anchor (passed through at cost)
                        </p>
                    </div>
                </div>

                <!-- Monthly Usage -->
                <div class="border border-gray-800 bg-card p-6">
                    <span class="mb-4 block text-[10px] uppercase tracking-wider text-gray-400" data-i18n="bill_month">
                        THIS MONTH
                    </span>
                    <div class="space-y-2 font-mono text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-400" data-i18n="bill_records">Total Records</span>
                            <span class="text-white" id="month-records">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400" data-i18n="bill_anchors">Anchors</span>
                            <span class="text-white" id="month-anchors">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400" data-i18n="bill_network_fee">Network Fee</span>
                            <span class="text-white" id="month-network">$0.00</span>
                        </div>
                        <div class="mt-3 flex justify-between border-t border-gray-800 pt-3">
                            <span class="font-medium text-white" data-i18n="bill_total">Total Cost</span>
                            <span class="font-medium text-white" id="month-total">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right column: Top-up + Batch tip + History -->
            <div class="flex flex-col gap-6">
                <!-- Top-up（真实充值接口） -->
                <div class="border border-gray-800 bg-card p-6">
                    <span class="mb-4 block text-[10px] uppercase tracking-wider text-gray-400" data-i18n="bill_topup">
                        ADD FUNDS
                    </span>
                    <div class="flex flex-wrap gap-2">
                        <button class="preset-btn border border-gray-700 px-5 py-2.5 font-mono text-sm text-white transition-colors hover:border-steel hover:bg-steel/10 disabled:opacity-40 disabled:cursor-not-allowed" data-amount="10">$10</button>
                        <button class="preset-btn border border-gray-700 px-5 py-2.5 font-mono text-sm text-white transition-colors hover:border-steel hover:bg-steel/10 disabled:opacity-40 disabled:cursor-not-allowed" data-amount="50">$50</button>
                        <button class="preset-btn border border-gray-700 px-5 py-2.5 font-mono text-sm text-white transition-colors hover:border-steel hover:bg-steel/10 disabled:opacity-40 disabled:cursor-not-allowed" data-amount="100">$100</button>
                    </div>
                    <div class="mt-3 flex gap-2">
                        <input
                            type="number"
                            id="custom-amount"
                            min="1"
                            step="1"
                            placeholder="Custom amount"
                            class="min-w-0 flex-1 border border-gray-700 bg-background px-3 py-2.5 font-mono text-sm text-white placeholder:text-gray-500 outline-none transition-colors focus:border-steel disabled:opacity-40"
                            disabled
                        />
                        <button
                            id="add-funds-btn"
                            class="shrink-0 border border-steel bg-steel/10 px-5 py-2.5 text-sm font-medium text-white transition-colors hover:bg-steel/20 disabled:opacity-40 disabled:cursor-not-allowed"
                            disabled
                        >
                            Add Funds
                        </button>
                    </div>
                    <div id="topup-status" class="mt-2 text-xs text-gray-400"></div>
                </div>

                <!-- Batch anchoring tip -->
                <div class="border-l-2 border-steel bg-steel/5 px-5 py-4">
                    <p class="font-mono text-xs leading-relaxed text-gray-400" data-i18n="bill_batch_tip">
                        Batch anchoring with Merkle tree reduces network fee by up to 99%. 
                        Network fee is amortized across batch. HJS fee applies per anchor.
                    </p>
                </div>

                <!-- Transaction History -->
                <div class="border border-gray-800 bg-card p-6">
                    <span class="mb-4 block text-[10px] uppercase tracking-wider text-gray-400" data-i18n="bill_history">
                        TRANSACTION HISTORY
                    </span>
                    <div id="history-container" class="space-y-0 divide-y divide-gray-800 max-h-60 overflow-y-auto">
                        <p class="font-mono text-xs text-gray-400 py-4 text-center" data-i18n="bill_history_empty">
                            No transactions yet
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- ===== 底部 ===== -->
        <div class="text-center text-xs text-gray-600 pt-10 border-t border-gray-800 mt-12">
            <a href="https://github.com/schchit/hjs-api" class="hover:text-gray-400 mx-2">GitHub</a>
            <span class="text-gray-700">·</span>
            <a href="/spec/README.md" class="hover:text-gray-400 mx-2">Spec</a>
            <span class="text-gray-700">·</span>
            <a href="/cases.html" class="hover:text-gray-400 mx-2">Cases</a>
        </div>
    </div>

    <!-- ===== 全局语言层 ===== -->
    <script src="/js/lang.js"></script>
    <script>
        // API 基础地址
        const API_BASE = 'https://hjs-api.onrender.com';

        // ===== 状态管理 =====
        let currentEmail = localStorage.getItem('hjs_console_email') || '';
        let balance = 0;
        let transactions = [];

        // ===== DOM 元素 =====
        const unauthState = document.getElementById('unauth-state');
        const authState = document.getElementById('auth-state');
        const billingContent = document.getElementById('billing-content');
        const emailInput = document.getElementById('email-input');
        const verifyBtn = document.getElementById('verify-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const currentEmailSpan = document.getElementById('current-email');
        const balanceSpan = document.getElementById('balance-amount');
        const topupSuccess = document.getElementById('topup-success');
        const topupStatus = document.getElementById('topup-status');
        const monthRecords = document.getElementById('month-records');
        const monthAnchors = document.getElementById('month-anchors');
        const monthNetwork = document.getElementById('month-network');
        const monthTotal = document.getElementById('month-total');
        const historyContainer = document.getElementById('history-container');
        const customAmount = document.getElementById('custom-amount');
        const addFundsBtn = document.getElementById('add-funds-btn');
        const presetBtns = document.querySelectorAll('.preset-btn');

        // 初始化邮箱输入
        if (currentEmail) {
            unauthState.classList.add('hidden');
            authState.classList.remove('hidden');
            currentEmailSpan.textContent = currentEmail;
            billingContent.classList.remove('opacity-40', 'pointer-events-none');
            enableBillingFeatures();
            loadBillingData();
        }

        // ===== 邮箱验证 =====
        verifyBtn.addEventListener('click', async () => {
            const email = emailInput.value.trim();
            if (!email || !email.includes('@')) return;
            
            verifyBtn.disabled = true;
            verifyBtn.textContent = '...';
            
            await new Promise(r => setTimeout(r, 600));
            
            currentEmail = email;
            localStorage.setItem('hjs_console_email', email);
            
            unauthState.classList.add('hidden');
            authState.classList.remove('hidden');
            currentEmailSpan.textContent = email;
            billingContent.classList.remove('opacity-40', 'pointer-events-none');
            
            enableBillingFeatures();
            loadBillingData();
            
            verifyBtn.disabled = false;
            verifyBtn.textContent = 'Verify';
        });

        logoutBtn.addEventListener('click', () => {
            currentEmail = '';
            localStorage.removeItem('hjs_console_email');
            
            unauthState.classList.remove('hidden');
            authState.classList.add('hidden');
            billingContent.classList.add('opacity-40', 'pointer-events-none');
            
            disableBillingFeatures();
            clearBillingData();
        });

        function enableBillingFeatures() {
            customAmount.disabled = false;
            addFundsBtn.disabled = false;
            presetBtns.forEach(btn => btn.disabled = false);
        }

        function disableBillingFeatures() {
            customAmount.disabled = true;
            addFundsBtn.disabled = true;
            presetBtns.forEach(btn => btn.disabled = true);
        }

        function clearBillingData() {
            balance = 0;
            transactions = [];
            updateUI();
            renderTransactions();
        }

        async function loadBillingData() {
            await Promise.all([
                fetchBalance(),
                fetchMetrics(),
                fetchTransactions(),
                fetchPricing()
            ]);
        }

        async function fetchPricing() {
            try {
                const res = await fetch(`${API_BASE}/billing/pricing?email=${encodeURIComponent(currentEmail)}`);
                if (res.ok) {
                    const data = await res.json();
                    updatePricingUI(data);
                }
            } catch (err) {
                console.error('Fetch pricing error:', err);
            }
        }

        function updatePricingUI(pricing) {
            const currentLang = localStorage.getItem('hjs_lang') || 'en';
            const t = translations[currentLang] || translations.en;
            
            // Helper to get tier name
            const getTierName = (tierKey) => {
                const tierMap = {
                    'experience': t.bill_tier_experience,
                    'standard': t.bill_tier_standard,
                    'bulk': t.bill_tier_bulk,
                    'enterprise': t.bill_tier_enterprise
                };
                return tierMap[tierKey] || tierKey.charAt(0).toUpperCase() + tierKey.slice(1);
            };
            
            // Update current tier badge
            const currentTier = pricing.current;
            document.getElementById('current-tier-name').textContent = getTierName(currentTier.tier);
            document.getElementById('current-tier-price').textContent = 
                `$${currentTier.price.toFixed(3)}`;
            document.getElementById('anchors-this-month').textContent = 
                currentLang === 'zh' ? `${currentTier.count} 次锚定` : `${currentTier.count} anchors`;
            
            // Highlight current tier row
            document.querySelectorAll('.tier-row').forEach(row => {
                row.classList.remove('bg-steel/10', 'border', 'border-steel');
                if (row.dataset.tier === currentTier.tier) {
                    row.classList.add('bg-steel/10', 'border', 'border-steel');
                    row.querySelector('.rounded-full').classList.remove('bg-gray-600');
                    row.querySelector('.rounded-full').classList.add('bg-steel');
                }
            });
            
            // Update progress to next tier
            if (pricing.nextTier) {
                const progress = Math.min(100, (currentTier.count / pricing.nextTier.at) * 100);
                document.getElementById('tier-progress-bar').style.width = `${progress}%`;
                const remaining = pricing.nextTier.at - currentTier.count;
                document.getElementById('next-tier-threshold').textContent = 
                    currentLang === 'zh' ? `再${remaining}次到${getTierName(pricing.nextTier.at > 10000 ? 'enterprise' : pricing.nextTier.at > 1000 ? 'bulk' : 'standard')}` : `${remaining} to ${pricing.nextTier.at}`;
                document.getElementById('next-tier-savings').textContent = 
                    currentLang === 'zh' ? `下一等级可省 ${pricing.nextTier.savePercentage}%` : `Save ${pricing.nextTier.savePercentage}% at next tier`;
                document.getElementById('next-tier-savings').classList.remove('hidden');
            } else {
                document.getElementById('tier-progress-bar').style.width = '100%';
                document.getElementById('next-tier-threshold').textContent = 
                    currentLang === 'zh' ? '已达最高等级' : 'Max tier reached';
                document.getElementById('next-tier-savings').classList.add('hidden');
            }
        }

        async function fetchBalance() {
            try {
                const res = await fetch(`${API_BASE}/billing/balance?email=${encodeURIComponent(currentEmail)}`);
                if (res.ok) {
                    const data = await res.json();
                    balance = data.balance || 0;
                }
            } catch (err) {
                console.error('Fetch balance error:', err);
                balance = 0;
            }
            updateUI();
        }

        async function fetchMetrics() {
            try {
                const res = await fetch(`${API_BASE}/metrics?email=${encodeURIComponent(currentEmail)}`);
                if (res.ok) {
                    const data = await res.json();
                    monthRecords.textContent = data.total_judgments || 0;
                    monthAnchors.textContent = data.monthly_anchors || 0;
                    
                    // 估算网络费（假设每个锚定 $0.32 网络费）
                    const networkFee = (data.monthly_anchors || 0) * 0.32;
                    monthNetwork.textContent = `$${networkFee.toFixed(2)}`;
                    
                    // 总费用 = 锚定服务费 ($0.03/次) + 网络费
                    const total = (data.monthly_anchors * 0.03) + networkFee;
                    monthTotal.textContent = `$${total.toFixed(2)}`;
                    
                    // 更新余额（可能已经在fetchBalance中更新）
                    if (data.balance !== undefined) {
                        balance = data.balance;
                        updateUI();
                    }
                }
            } catch (err) {
                console.error('Fetch metrics error:', err);
            }
        }

        async function fetchTransactions() {
            try {
                const res = await fetch(`${API_BASE}/billing/transactions?email=${encodeURIComponent(currentEmail)}&limit=20`);
                if (res.ok) {
                    const data = await res.json();
                    transactions = data.transactions || [];
                }
            } catch (err) {
                console.error('Fetch transactions error:', err);
                transactions = [];
            }
            renderTransactions();
        }

        async function addFunds(amount) {
            if (amount <= 0 || !currentEmail) return;
            
            addFundsBtn.disabled = true;
            addFundsBtn.textContent = 'Processing...';
            topupStatus.textContent = '';
            
            try {
                const res = await fetch(`${API_BASE}/billing/topup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: currentEmail, amount })
                });
                
                if (res.ok) {
                    const data = await res.json();
                    balance = data.new_balance;
                    
                    // 显示成功提示
                    topupSuccess.textContent = `+$${amount.toFixed(2)}`;
                    topupSuccess.classList.remove('hidden');
                    setTimeout(() => topupSuccess.classList.add('hidden'), 2500);
                    
                    // 重新获取交易历史
                    await fetchTransactions();
                    
                    updateUI();
                    
                    // 清空输入
                    customAmount.value = '';
                    topupStatus.textContent = '✅ 充值成功';
                    setTimeout(() => topupStatus.textContent = '', 3000);
                } else {
                    const err = await res.json();
                    topupStatus.textContent = `❌ ${err.error || '充值失败'}`;
                }
            } catch (err) {
                console.error('Top-up error:', err);
                topupStatus.textContent = '❌ 网络错误，请重试';
            } finally {
                addFundsBtn.disabled = false;
                addFundsBtn.textContent = 'Add Funds';
            }
        }

        presetBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const amount = parseFloat(btn.getAttribute('data-amount'));
                addFunds(amount);
            });
        });

        addFundsBtn.addEventListener('click', () => {
            const amount = parseFloat(customAmount.value);
            if (amount > 0) {
                addFunds(amount);
            }
        });

        function updateUI() {
            balanceSpan.textContent = `$${balance.toFixed(2)}`;
        }

        function renderTransactions() {
            if (transactions.length === 0) {
                historyContainer.innerHTML = `<p class="font-mono text-xs text-gray-400 py-4 text-center" data-i18n="bill_history_empty">No transactions yet</p>`;
                return;
            }
            
            let html = '';
            transactions.slice(0, 10).forEach(tx => {
                const isTopup = tx.type === 'topup' || tx.amount > 0;
                const date = new Date(tx.date).toLocaleDateString();
                const amount = Math.abs(tx.amount).toFixed(2);
                
                html += `
                    <div class="flex items-center justify-between py-2 font-mono text-xs">
                        <div class="flex flex-col gap-0.5">
                            <span class="text-gray-500">${date}</span>
                            <span class="text-gray-400">${tx.type}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-white">${isTopup ? '+' : '-'}$${amount}</span>
                        </div>
                    </div>
                `;
            });
            
            historyContainer.innerHTML = html;
        }

        // ===== 翻译字典 =====
        const translations = {
            en: {
                nav_home: "Home",
                nav_product: "Product",
                nav_developers: "Developers",
                nav_console: "Console",
                nav_lookup: "Lookup",
                nav_billing: "Billing",
                nav_roi: "ROI",
                nav_governance: "Governance",
                nav_roi: "ROI",
                con_auth_current: "Current",
                bill_version_tag: "HJS Responsibility Protocol · v1.0 Beta",
                bill_title: "Usage & Billing",
                bill_subtitle: "Free storage · Pay only for anchoring",
                bill_auth_heading: "EMAIL AUTHENTICATION",
                bill_balance: "CURRENT BALANCE",
                bill_rates: "TIERED RATES",
                bill_current_tier: "Current Tier",
                bill_per_anchor: "/anchor",
                bill_tier_experience: "Experience",
                bill_tier_standard: "Standard",
                bill_tier_bulk: "Bulk",
                bill_tier_enterprise: "Enterprise",
                bill_rate_storage: "Record Storage",
                bill_rate_anchor: "Anchoring",
                bill_network_note: "Bitcoin network fee passed through at cost. Current estimate: $0.32 per anchor.",
                bill_month: "THIS MONTH",
                bill_records: "Total Records",
                bill_anchors: "Anchors",
                bill_network_fee: "Network Fee",
                bill_total: "Total Cost",
                bill_topup: "ADD FUNDS",
                bill_custom: "Custom amount",
                bill_add: "Add Funds",
                bill_batch_tip: "Batch anchoring with Merkle tree reduces network fee by up to 99%. Network fee is amortized across batch. HJS fee applies per anchor.",
                bill_history: "TRANSACTION HISTORY",
                bill_history_empty: "No transactions yet"
            },
            zh: {
                nav_home: "首页",
                nav_product: "产品",
                nav_developers: "开发者",
                nav_console: "控制台",
                nav_lookup: "查询",
                nav_billing: "计费",
                nav_roi: "ROI",
                nav_governance: "治理",
                nav_roi: "ROI",
                con_auth_current: "当前邮箱",
                bill_version_tag: "HJS 责任协议 · v1.0 Beta",
                bill_title: "用量与计费",
                bill_subtitle: "存储免费 · 仅锚定收费",
                bill_auth_heading: "邮箱验证",
                bill_balance: "当前余额",
                bill_rates: "阶梯费率",
                bill_current_tier: "当前等级",
                bill_per_anchor: "/次",
                bill_tier_experience: "体验版",
                bill_tier_standard: "标准版",
                bill_tier_bulk: "批量版",
                bill_tier_enterprise: "企业版",
                bill_rate_storage: "记录存储",
                bill_rate_anchor: "锚定服务",
                bill_network_note: "比特币网络费按实际成本转嫁。当前估算：$0.32/次。",
                bill_month: "本月用量",
                bill_records: "总记录数",
                bill_anchors: "锚定数",
                bill_network_fee: "网络费",
                bill_total: "总费用",
                bill_topup: "充值",
                bill_custom: "自定义金额",
                bill_add: "充值",
                bill_batch_tip: "使用默克尔树批量锚定可降低高达99%的网络费。网络费按批次分摊。HJS处理费按次收取。",
                bill_history: "交易历史",
                bill_history_empty: "暂无交易记录"
            }
        };

        function switchLang(lang) {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    el.innerHTML = translations[lang][key];
                }
            });
            const select = document.querySelector('select');
            if (select) select.value = lang;
        }

        (function() {
            const lang = document.documentElement.lang || localStorage.getItem('hjs_lang') || 'en';
            switchLang(lang);
        })();
    </script>

</body>
</html>